<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Moto Horizon - Radar & Postos</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root { --accent: #00ff00; --danger: #ff0000; --bg: #0b0d12; }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; overflow: hidden; }

        /* Mapa e Radar */
        #map { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; background: var(--bg); }

        /* Overlay de Alerta (Flash) */
        #flash {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 999; pointer-events: none; opacity: 0; background: #ffcc00;
        }

        /* Interface UI */
        #ui { position: relative; z-index: 10; height: 100vh; display: flex; flex-direction: column; justify-content: space-between; pointer-events: none; }
        .active-ui { pointer-events: auto; }

        /* Horizonte Artificial (Topo Esquerdo) */
        #horizon {
            width: 110px; height: 110px; border-radius: 50%; border: 2px solid #444;
            position: absolute; top: 15px; left: 15px; overflow: hidden; background: #1e3a5f;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }
        #sky {
            position: absolute; width: 250%; height: 250%; top: -75%; left: -75%;
            background: linear-gradient(to bottom, #2980b9 50%, #5d3a1a 50%);
            transition: transform 0.05s linear;
        }
        #center-line { position: absolute; top: 50%; left: 15%; width: 70%; height: 2px; background: yellow; z-index: 5; }

        /* Painel de Postos (Topo Direito) */
        #stations-panel {
            position: absolute; top: 15px; right: 15px; width: 170px;
            background: rgba(0,0,0,0.8); border: 1px solid #333; border-radius: 10px;
            padding: 10px; font-size: 11px; max-height: 40vh; overflow-y: auto;
        }
        .st-item { border-bottom: 1px solid #222; padding: 6px 0; }
        .st-item b { color: var(--accent); display: block; text-transform: uppercase; }

        /* Dashboard Inferior */
        #dash {
            background: rgba(0,0,0,0.9); padding: 15px; display: grid;
            grid-template-columns: repeat(4, 1fr); text-align: center;
            border-top: 1px solid #333;
        }
        .v { font-size: 1.5rem; font-weight: bold; color: var(--accent); display: block; }
        .l { font-size: 0.6rem; color: #777; text-transform: uppercase; }

        /* Botão Start */
        #overlay-start {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 1000; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        #btn-start { padding: 20px 40px; background: var(--accent); border: none; border-radius: 40px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <div id="overlay-start">
        <h2 style="margin-bottom:20px">SISTEMA DE EXPEDIÇÃO</h2>
        <button id="btn-start" class="active-ui">ATIVAR PAINEL TÁTICO</button>
    </div>

    <div id="flash"></div>
    <div id="map"></div>

    <div id="ui">
        <div id="horizon">
            <div id="sky"></div>
            <div id="center-line"></div>
        </div>

        <div id="stations-panel">
            <div style="color:var(--accent); font-weight:bold; margin-bottom:5px; border-bottom:1px solid #444">⛽ POSTOS SEGUROS</div>
            <div id="list">Localizando...</div>
        </div>

        <div id="dash">
            <div class="stat"><span id="spd" class="v">0</span><span class="l">km/h</span></div>
            <div class="stat"><span id="alt" class="v">--</span><span class="l">Altitude</span></div>
            <div class="stat"><span id="wea" class="v">--</span><span class="l">Clima</span></div>
            <div class="stat"><span id="pit" class="v">0°</span><span class="l">Inclinação</span></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const API_KEY = "d0bd25d6a9954ce24084e7358c237204";
        let map, userMarker, audioCtx, lastWeather = 0;

        document.getElementById('btn-start').onclick = function() {
            document.getElementById('overlay-start').style.display = 'none';
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            init();
        };

        function init() {
            // Mapa Base OSM (Não fica preto)
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView([0,0], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { opacity: 0.8 }).addTo(map);

            // Camada de Radar RainViewer (Cores da Chuva)
            L.tileLayer('https://tilecache.rainviewer.com/v2/radar/nowcast_5/256/{z}/{x}/{y}/2/1_1.png', {
                opacity: 0.6, zIndex: 100
            }).addTo(map);

            startTracking();
            startSensors();
        }

        function startTracking() {
            navigator.geolocation.watchPosition(pos => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                const speed = Math.round((pos.coords.speed || 0) * 3.6);
                
                map.setView([lat, lon], 12);
                if(!userMarker) userMarker = L.circleMarker([lat, lon], {color: '#00ff00', radius: 8, fillOpacity: 1}).addTo(map);
                else userMarker.setLatLng([lat, lon]);

                document.getElementById('spd').innerText = speed;
                document.getElementById('alt').innerText = Math.round(pos.coords.altitude || 0) + "m";

                if (Date.now() - lastWeather > 300000) {
                    updateWeather(lat, lon);
                    updateStations(lat, lon);
                    lastWeather = Date.now();
                }
            }, null, { enableHighAccuracy: true });
        }

        async function updateWeather(lat, lon) {
            try {
                const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${API_KEY}&units=metric&lang=pt_br`);
                const data = await res.json();
                const main = data.weather[0].main;
                document.getElementById('wea').innerText = main;

                if(["Rain", "Thunderstorm", "Drizzle"].includes(main)) {
                    document.getElementById('wea').style.color = "red";
                    // Alerta Flash e Beep
                    document.getElementById('flash').style.opacity = "0.5";
                    setTimeout(() => document.getElementById('flash').style.opacity = "0", 300);
                    if(audioCtx) {
                        const o = audioCtx.createOscillator();
                        o.connect(audioCtx.destination);
                        o.start(); o.stop(audioCtx.currentTime + 0.1);
                    }
                } else { document.getElementById('wea').style.color = "var(--accent)"; }
            } catch(e) {}
        }

        async function updateStations(lat, lon) {
            // Busca postos com conveniência num raio de 30km
            const q = `[out:json];node["amenity"="fuel"](around:30000,${lat},${lon});out 5;`;
            try {
                const res = await fetch('https://overpass-api.de/api/interpreter?data=' + encodeURIComponent(q));
                const data = await res.json();
                let h = "";
                data.elements.forEach(e => {
                    h += `<div class="st-item"><b>${e.tags.name || 'Posto 24h'}</b>Seguro para Parar</div>`;
                });
                document.getElementById('list').innerHTML = h || "Buscando...";
            } catch(e) {}
        }

        function startSensors() {
            window.addEventListener('deviceorientation', e => {
                let p = Math.round(e.beta); 
                let r = Math.round(e.gamma);
                document.getElementById('pit').innerText = p + "°";
                document.getElementById('sky').style.transform = `rotate(${-r}deg) translateY(${p}px)`;
            });
        }
    </script>
</body>
</html>
