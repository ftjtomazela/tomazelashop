<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radar Meteorol칩gico</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; background: #111; color: white; font-family: Arial, sans-serif; }
        #map { height: 100vh; width: 100%; background: #1a1a1a; }
        
        #controles {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 30px;
            border-radius: 50px;
            backdrop-filter: blur(5px);
            border: 2px solid #00a8ff;
            box-shadow: 0 0 20px rgba(0, 168, 255, 0.3);
            z-index: 1000;
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .status {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .led {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #00ff00;
            box-shadow: 0 0 10px #00ff00;
            animation: piscar 2s infinite;
        }
        
        @keyframes piscar {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        #timestamp {
            color: #00a8ff;
            font-size: 14px;
        }
        
        #info {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 14px;
            border-left: 4px solid #00a8ff;
            z-index: 1000;
        }
        
        .opacity-control {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            z-index: 1000;
            color: white;
            min-width: 200px;
        }
        
        input[type=range] {
            width: 100%;
            margin: 10px 0;
            background: #333;
            height: 5px;
            border-radius: 5px;
            -webkit-appearance: none;
        }
        
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #00a8ff;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px #00a8ff;
        }
        
        #carregando {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            z-index: 2000;
            border: 2px solid #00a8ff;
            display: none;
        }
        
        .spinner {
            border: 4px solid #333;
            border-top: 4px solid #00a8ff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: girar 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes girar {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        #zoom-control {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 10px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .zoom-btn {
            background: #00a8ff;
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.3s;
        }
        
        .zoom-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 15px #00a8ff;
        }
        
        .legenda {
            position: fixed;
            top: 100px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 10px;
            z-index: 1000;
            font-size: 12px;
        }
        
        .legenda-item {
            display: flex;
            align-items: center;
            gap: 5px;
            margin: 5px 0;
        }
        
        .cor {
            width: 20px;
            height: 20px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div id="controles">
        <div class="status">
            <span class="led"></span>
            <span>RADAR ATIVO</span>
        </div>
        <div id="timestamp">Atualizando...</div>
    </div>
    
    <div id="zoom-control">
        <button class="zoom-btn" onclick="map.zoomIn()">+</button>
        <button class="zoom-btn" onclick="map.zoomOut()">-</button>
    </div>
    
    <div class="legenda">
        <h4>Intensidade da Precipita칞칚o</h4>
        <div class="legenda-item">
            <div class="cor" style="background: rgba(0, 255, 0, 0.3);"></div>
            <span>Muito Fraca</span>
        </div>
        <div class="legenda-item">
            <div class="cor" style="background: rgba(0, 255, 0, 0.8);"></div>
            <span>Fraca</span>
        </div>
        <div class="legenda-item">
            <div class="cor" style="background: rgba(255, 255, 0, 0.8);"></div>
            <span>Moderada</span>
        </div>
        <div class="legenda-item">
            <div class="cor" style="background: rgba(255, 0, 0, 0.8);"></div>
            <span>Forte</span>
        </div>
        <div class="legenda-item">
            <div class="cor" style="background: rgba(255, 0, 255, 0.8);"></div>
            <span>Muito Forte</span>
        </div>
    </div>
    
    <div class="opacity-control">
        <label>Opacidade do Radar</label>
        <input type="range" id="opacidade" min="0.1" max="1" step="0.1" value="0.7">
        <div style="display: flex; justify-content: space-between;">
            <span>Menos</span>
            <span id="opacidade-valor">70%</span>
            <span>Mais</span>
        </div>
    </div>
    
    <div id="info">
        <div><strong>游늸 Localiza칞칚o:</strong> <span id="local">Obtendo...</span></div>
        <div><strong>游뎷 칔ltima atualiza칞칚o:</strong> <span id="hora">---</span></div>
        <div><strong>游니 Fonte:</strong> RainViewer</div>
    </div>
    
    <div id="carregando">
        <div class="spinner"></div>
        <div>Atualizando radar...</div>
    </div>
    
    <div id="map"></div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map;
        let radarLayer = null;
        let userMarker = null;
        let atualizacaoInterval;
        
        // Inicializar mapa
        function initMap() {
            map = L.map('map').setView([-23.5505, -46.6333], 8);
            
            // Camada base escura
            L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/dark_all/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap'
            }).addTo(map);
            
            // Iniciar radar
            atualizarRadar();
            
            // Atualizar a cada 5 minutos
            atualizacaoInterval = setInterval(atualizarRadar, 5 * 60 * 1000);
            
            // Controle de opacidade
            document.getElementById('opacidade').addEventListener('input', function(e) {
                const valor = e.target.value;
                document.getElementById('opacidade-valor').textContent = Math.round(valor * 100) + '%';
                if (radarLayer) {
                    radarLayer.setOpacity(valor);
                }
            });
            
            // Tentar obter localiza칞칚o
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(pos) {
                        const lat = pos.coords.latitude;
                        const lon = pos.coords.longitude;
                        
                        document.getElementById('local').textContent = 
                            lat.toFixed(4) + ', ' + lon.toFixed(4);
                        
                        // Centralizar no usu치rio
                        map.setView([lat, lon], 8);
                        
                        // Adicionar marcador
                        if (userMarker) {
                            userMarker.setLatLng([lat, lon]);
                        } else {
                            userMarker = L.circleMarker([lat, lon], {
                                color: '#00a8ff',
                                radius: 10,
                                fillColor: '#00a8ff',
                                fillOpacity: 0.8,
                                weight: 2
                            }).addTo(map);
                            userMarker.bindPopup('游늸 Sua localiza칞칚o');
                        }
                    },
                    function() {
                        document.getElementById('local').textContent = 'N칚o dispon칤vel';
                    }
                );
            }
        }
        
        // Fun칞칚o principal do radar
        async function atualizarRadar() {
            const carregando = document.getElementById('carregando');
            carregando.style.display = 'block';
            
            try {
                // Buscar dados do RainViewer
                const response = await fetch('https://api.rainviewer.com/public/weather-maps.json');
                const data = await response.json();
                
                if (data.radar && data.radar.past && data.radar.past.length > 0) {
                    // Pegar o mais recente
                    const ultimo = data.radar.past[data.radar.past.length - 1];
                    
                    // Formatar timestamp
                    const dataRadar = new Date(ultimo.time * 1000);
                    document.getElementById('timestamp').textContent = 
                        dataRadar.toLocaleString('pt-BR');
                    document.getElementById('hora').textContent = 
                        dataRadar.toLocaleTimeString('pt-BR');
                    
                    // URL do radar (usando a melhor qualidade)
                    const radarUrl = `https://tilecache.rainviewer.com${ultimo.path}/256/{z}/{x}/{y}/2/1_1.png`;
                    
                    // Remover camada antiga se existir
                    if (radarLayer) {
                        map.removeLayer(radarLayer);
                    }
                    
                    // Adicionar nova camada
                    radarLayer = L.tileLayer(radarUrl, {
                        opacity: document.getElementById('opacidade').value,
                        zIndex: 500,
                        transparent: true
                    }).addTo(map);
                    
                    console.log('Radar atualizado:', new Date().toLocaleTimeString());
                }
            } catch (error) {
                console.error('Erro ao carregar radar:', error);
                document.getElementById('timestamp').innerHTML = '丘멆잺 Erro ao carregar';
            } finally {
                carregando.style.display = 'none';
            }
        }
        
        // For칞ar atualiza칞칚o manual
        function forcarAtualizacao() {
            atualizarRadar();
        }
        
        // Atalhos de teclado
        document.addEventListener('keydown', function(e) {
            if (e.key === 'r' || e.key === 'R') {
                atualizarRadar();
            }
        });
        
        // Iniciar quando a p치gina carregar
        window.onload = initMap;
        
        // Limpar intervalo quando sair da p치gina
        window.onbeforeunload = function() {
            if (atualizacaoInterval) {
                clearInterval(atualizacaoInterval);
            }
        };
    </script>
</body>
</html>