<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Radar Meteorológico Pro</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; background: #000; color: white; font-family: sans-serif; overflow: hidden; }
        #map { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        
        /* Alerta de Chuva (Tela Piscando) */
        #alert-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 999; pointer-events: none; opacity: 0;
            background: rgba(255, 204, 0, 0.6); /* Amarelo Alerta */
        }

        #ui-top {
            position: absolute; top: 10px; width: 100%; display: flex;
            justify-content: center; z-index: 10; pointer-events: none;
        }
        .warning-box {
            background: rgba(255, 0, 0, 0.8); padding: 10px 20px;
            border-radius: 20px; font-weight: bold; display: none; /* Escondido por padrão */
        }

        #dashboard {
            position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.8);
            display: flex; justify-content: space-around; padding: 15px 0; z-index: 10;
        }
        .stat { text-align: center; }
        .val { font-size: 1.5rem; font-weight: bold; color: #00ff00; display: block; }
        .label { font-size: 0.7rem; color: #aaa; text-transform: uppercase; }

        #btn-start {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: #111; z-index: 1000; display: flex; justify-content: center; align-items: center;
        }
        button { padding: 20px 40px; font-size: 1.2rem; background: #00ff00; border: none; border-radius: 30px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="btn-start">
        <button onclick="iniciar()">LIGAR RADAR E AVISOS</button>
    </div>

    <div id="alert-overlay"></div>
    
    <div id="ui-top">
        <div id="msg-alerta" class="warning-box">⚠️ ALERTA DE CHUVA NA ROTA</div>
    </div>

    <div id="map"></div>

    <div id="dashboard">
        <div class="stat"><span id="speed" class="val">0</span><span class="label">km/h</span></div>
        <div class="stat"><span id="clima" class="val">--</span><span class="label">Condição</span></div>
        <div class="stat"><span id="dist" class="val">30km</span><span class="label">Raio Monitor</span></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const API_KEY = "d0bd25d6a9954ce24084e7358c237204";
        let map, userMarker, audioCtx;

        function iniciar() {
            document.getElementById('btn-start').style.display = 'none';
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            
            // 1. Mapa Base (Escuro para destacar a chuva)
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView([0,0], 13);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

            // 2. Camada de RADAR (Cores de Chuva do RainViewer)
            // Esta URL pega o radar mais recente e joga no mapa
            L.tileLayer('https://tilecache.rainviewer.com/v2/radar/nowcast_5/256/{z}/{x}/{y}/2/1_1.png', {
                opacity: 0.7,
                zIndex: 100
            }).addTo(map);

            rastrear();
        }

        function rastrear() {
            navigator.geolocation.watchPosition(pos => {
                const { latitude, longitude, speed } = pos.coords;
                const latlng = [latitude, longitude];

                map.setView(latlng);
                if(!userMarker) userMarker = L.circleMarker(latlng, {color: '#00ff00', radius: 10}).addTo(map);
                else userMarker.setLatLng(latlng);

                document.getElementById('speed').innerText = speed ? Math.round(speed * 3.6) : 0;

                verificarClima(latitude, longitude);
            }, null, { enableHighAccuracy: true });
        }

        async function verificarClima(lat, lon) {
            try {
                const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${API_KEY}&units=metric&lang=pt_br`);
                const data = await res.json();
                const tempo = data.weather[0].main;
                
                document.getElementById('clima').innerText = data.weather[0].description;

                // Se detectar chuva (Rain) ou tempestade (Thunderstorm)
                if(["Rain", "Thunderstorm", "Drizzle"].includes(tempo)) {
                    dispararAviso();
                } else {
                    pararAviso();
                }
            } catch(e) { console.log("Erro API"); }
        }

        function dispararAviso() {
            // Mostra o texto vermelho no topo
            document.getElementById('msg-alerta').style.display = 'block';
            
            // Faz a tela piscar amarelo
            const overlay = document.getElementById('alert-overlay');
            overlay.style.opacity = "0.5";
            setTimeout(() => overlay.style.opacity = "0", 300);

            // Som de Beep
            if(audioCtx) {
                const osc = audioCtx.createOscillator();
                osc.connect(audioCtx.destination);
                osc.frequency.value = 880;
                osc.start();
                osc.stop(audioCtx.currentTime + 0.1);
            }
        }

        function pararAviso() {
            document.getElementById('msg-alerta').style.display = 'none';
        }
    </script>
</body>
</html>
