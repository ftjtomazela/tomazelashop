<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Moto Horizon Pro V2</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root { --danger: #ff0000; --warning: #ffcc00; --accent: #00ff00; }
        body { margin: 0; background: #080a0f; color: white; font-family: sans-serif; overflow: hidden; }

        /* Mapa com fundo de seguran√ßa para n√£o ficar "preto" */
        #map { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; background: #080a0f; }

        #alert-flash {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 999; pointer-events: none; opacity: 0; background: var(--warning);
        }

        #ui-layer { position: relative; z-index: 10; height: 100vh; display: flex; flex-direction: column; justify-content: space-between; pointer-events: none; }
        .interactive { pointer-events: auto; }

        /* Horizonte Artificial */
        #horizon-box {
            width: 120px; height: 120px; border-radius: 50%; border: 2px solid #555;
            position: absolute; top: 15px; left: 15px; overflow: hidden; background: #2c3e50;
        }
        #sky {
            position: absolute; width: 250%; height: 250%; top: -75%; left: -75%;
            background: linear-gradient(to bottom, #1e528e 50%, #5d3a1a 50%);
        }
        #horizon-fixed {
            position: absolute; top: 50%; left: 15%; width: 70%; height: 2px; background: yellow; z-index: 5;
        }

        /* Lista de Postos */
        #gas-info {
            position: absolute; top: 15px; right: 15px; width: 160px;
            background: rgba(0,0,0,0.7); border-radius: 8px; padding: 10px; font-size: 10px;
        }
        .station { border-bottom: 1px solid #333; padding: 4px 0; }

        /* Dashboard Inferior */
        #dashboard {
            background: rgba(0,0,0,0.85); padding: 15px; display: grid; 
            grid-template-columns: repeat(4, 1fr); text-align: center;
        }
        .stat-val { font-size: 1.4rem; font-weight: bold; color: var(--accent); display: block; }
        .stat-label { font-size: 0.6rem; color: #aaa; text-transform: uppercase; }

        #starter {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 1000; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        button { padding: 20px 40px; background: var(--accent); border: none; border-radius: 30px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <div id="starter">
        <h2 style="color:white">SISTEMA DE EXPEDI√á√ÉO</h2>
        <button id="start-btn" class="interactive">INICIAR PAINEL</button>
    </div>

    <div id="alert-flash"></div>
    <div id="map"></div>

    <div id="ui-layer">
        <div id="horizon-box">
            <div id="sky"></div>
            <div id="horizon-fixed"></div>
        </div>

        <div id="gas-info">
            <div style="color:var(--accent); margin-bottom:5px">‚õΩ POSTOS 24H</div>
            <div id="station-list">Aguardando GPS...</div>
        </div>

        <div id="dashboard">
            <div class="stat">
                <span id="speed" class="stat-val">0</span>
                <span class="stat-label">km/h</span>
            </div>
            <div class="stat">
                <span id="alt" class="stat-val">--</span>
                <span class="stat-label">Alt (m)</span>
            </div>
            <div class="stat">
                <span id="clima-txt" class="stat-val">--</span>
                <span class="stat-label">Tempo</span>
            </div>
            <div class="stat">
                <span id="pitch" class="stat-val">0¬∞</span>
                <span class="stat-label">N√≠vel</span>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // NOVA API FORNECIDA
        const API_KEY = "d0bd25d6a9954ce24084e7358c237204";
        let map, userMarker, audioCtx;
        let lastCheck = 0;

        document.getElementById('start-btn').onclick = function() {
            document.getElementById('starter').style.display = 'none';
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            init();
        };

        function init() {
            // TILE LAYER ALTERNATIVO (OpenStreetMap Standard) para evitar tela preta
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView([0,0], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                opacity: 0.7
            }).addTo(map);

            // Radar de Chuva RainViewer
            L.tileLayer('https://tilecache.rainviewer.com/v2/radar/nowcast_5/256/{z}/{x}/{y}/2/1_1.png', {
                opacity: 0.5, zIndex: 100
            }).addTo(map);

            startTracking();
            startSensors();
        }

        function startTracking() {
            navigator.geolocation.watchPosition(pos => {
                const { latitude, longitude, speed, altitude } = pos.coords;
                const latlng = [latitude, longitude];

                map.setView(latlng, 13);
                if(!userMarker) userMarker = L.circleMarker(latlng, {color: 'cyan', radius: 10, fillOpacity: 0.8}).addTo(map);
                else userMarker.setLatLng(latlng);

                document.getElementById('speed').innerText = speed ? Math.round(speed * 3.6) : 0;
                document.getElementById('alt').innerText = altitude ? Math.round(altitude) : "--";

                // Atualiza clima e postos a cada 5 minutos
                if(Date.now() - lastCheck > 300000) {
                    getWeather(latitude, longitude);
                    getStations(latitude, longitude);
                    lastCheck = Date.now();
                }
            }, (err) => alert("Ative o GPS do celular!"), { enableHighAccuracy: true });
        }

        async function getWeather(lat, lon) {
            try {
                const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${API_KEY}&units=metric&lang=pt_br`;
                const res = await fetch(url);
                const data = await res.json();
                const status = data.weather[0].main;
                
                document.getElementById('clima-txt').innerText = status;

                if(["Rain", "Thunderstorm", "Drizzle"].includes(status)) {
                    triggerAlert();
                    document.getElementById('clima-txt').style.color = "red";
                } else {
                    document.getElementById('clima-txt').style.color = "var(--accent)";
                }
            } catch(e) { document.getElementById('clima-txt').innerText = "Erro"; }
        }

        async function getStations(lat, lon) {
            const query = `[out:json];node["amenity"="fuel"](around:30000,${lat},${lon});out 5;`;
            try {
                const res = await fetch('https://overpass-api.de/api/interpreter?data=' + encodeURIComponent(query));
                const data = await res.json();
                let html = "";
                data.elements.forEach(e => {
                    html += `<div class="station"><b>üìç ${e.tags.name || 'Posto'}</b><br>Raio 30km</div>`;
                });
                document.getElementById('station-list').innerHTML = html || "Sem postos";
            } catch(e) { }
        }

        function triggerAlert() {
            const flash = document.getElementById('alert-flash');
            flash.style.opacity = "0.6";
            setTimeout(() => flash.style.opacity = "0", 300);

            if(audioCtx) {
                const osc = audioCtx.createOscillator();
                osc.connect(audioCtx.destination);
                osc.frequency.value = 440;
                osc.start();
                osc.stop(audioCtx.currentTime + 0.2);
            }
        }

        function startSensors() {
            window.addEventListener('deviceorientation', e => {
                let p = Math.round(e.beta); 
                let r = Math.round(e.gamma);
                document.getElementById('pitch').innerText = p + "¬∞";
                document.getElementById('sky').style.transform = `rotate(${-r}deg) translateY(${p}px)`;
            });
        }
    </script>
</body>
</html>
