<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Moto Horizon Fix</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; background: #222; color: #fff; font-family: sans-serif; overflow: hidden; }
        #map { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; background: #eee; }
        #ui { position: relative; z-index: 10; height: 100vh; pointer-events: none; }
        #horizon { width: 100px; height: 100px; border-radius: 50%; border: 2px solid #000; position: absolute; top: 10px; left: 10px; overflow: hidden; background: #1a2a3a; }
        #sky { position: absolute; width: 250%; height: 250%; top: -75%; left: -75%; background: linear-gradient(to bottom, #2980b9 50%, #8b4513 50%); }
        #stations { position: absolute; top: 10px; right: 10px; width: 180px; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 10px; font-size: 11px; pointer-events: auto; }
        #dash { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.9); display: flex; justify-content: space-around; padding: 15px 0; border-top: 2px solid #00ff00; }
        .v { font-size: 1.5rem; font-weight: bold; color: #00ff00; }
        #start { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 1000; display: flex; justify-content: center; align-items: center; pointer-events: auto; }
        button { padding: 20px; background: #00ff00; border: none; font-weight: bold; border-radius: 10px; }
    </style>
</head>
<body>

<div id="start"><button onclick="iniciar()">CLIQUE PARA ATIVAR TUDO</button></div>

<div id="map"></div>

<div id="ui">
    <div id="horizon"><div id="sky"></div></div>
    <div id="stations"><b>‚õΩ PR√ìXIMOS POSTOS:</b><div id="list">Buscando postos...</div></div>
    <div id="dash">
        <div><span id="spd" class="v">0</span><br>KM/H</div>
        <div><span id="wea" class="v">--</span><br>TEMPO</div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const KEY = "d0bd25d6a9954ce24084e7358c237204";
    let map, user;

    function iniciar() {
        document.getElementById('start').style.display = 'none';
        
        // Mapa base padr√£o (N√£o fica preto)
        map = L.map('map', { zoomControl: false }).setView([0,0], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        
        // Camada de Radar (Cores de chuva)
        L.tileLayer('https://tilecache.rainviewer.com/v2/radar/nowcast_5/256/{z}/{x}/{y}/2/1_1.png', {
            opacity: 0.6, zIndex: 100
        }).addTo(map);

        navigator.geolocation.watchPosition(p => {
            const lat = p.coords.latitude;
            const lon = p.coords.longitude;
            map.setView([lat, lon]);
            
            if(!user) user = L.circleMarker([lat, lon], {color:'blue', radius:10}).addTo(map);
            else user.setLatLng([lat, lon]);

            document.getElementById('spd').innerText = Math.round((p.coords.speed || 0) * 3.6);
            
            // Busca Postos e Clima
            fetchClima(lat, lon);
            fetchPostos(lat, lon);
        }, (err) => alert("GPS DESATIVADO!"), {enableHighAccuracy: true});
    }

    async function fetchClima(lat, lon) {
        try {
            const r = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${KEY}&lang=pt_br`);
            const d = await r.json();
            document.getElementById('wea').innerText = d.weather[0].main;
        } catch(e) {}
    }

    async function fetchPostos(lat, lon) {
        // Busca num raio de 20km
        const q = `[out:json];node["amenity"="fuel"](around:20000,${lat},${lon});out 5;`;
        try {
            const r = await fetch('https://overpass-api.de/api/interpreter?data=' + encodeURIComponent(q));
            const d = await r.json();
            let h = "";
            d.elements.forEach(e => {
                h += `<div>üìç ${e.tags.name || 'Posto'}</div>`;
            });
            document.getElementById('list').innerHTML = h || "Nenhum posto por perto";
        } catch(e) {
            document.getElementById('list').innerText = "Erro ao buscar postos";
        }
    }
</script>
</body>
</html>
