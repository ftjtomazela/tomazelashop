<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Moto Conchas - GPS</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: #f0f0f0; overflow: hidden; }
        #map { height: 100vh; width: 100vw; position: absolute; z-index: 1; }
        
        .leaflet-routing-container { display: none !important; }

        .bottom-sheet {
            position: absolute; bottom: 0; width: 100%;
            background: white; z-index: 100;
            padding: 20px; border-top-left-radius: 25px; border-top-right-radius: 25px;
            box-shadow: 0 -10px 25px rgba(0,0,0,0.15); padding-bottom: 30px;
        }

        .input-group { display: flex; align-items: center; background: #f4f4f4; border-radius: 12px; padding: 12px; margin-bottom: 12px; }
        .dot-origem { width: 10px; height: 10px; background: #3498db; border-radius: 50%; margin-right: 15px; }
        .dot-destino { width: 10px; height: 10px; background: #e74c3c; border-radius: 50%; margin-right: 15px; }
        input { border: none; background: transparent; width: 100%; font-size: 16px; outline: none; }
        .gps-ativo { border: 2px solid #2ecc71; background: #e8f8f5; }
        .btn-confirmar { width: 100%; background: #000; color: white; border: none; padding: 18px; border-radius: 15px; font-size: 18px; font-weight: bold; cursor: pointer; }
        
        /* Loader e Tempo */
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #000; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 10px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Estilo do Tempo Estimado */
        .tempo-destaque {
            font-size: 2.5em;
            font-weight: 800;
            color: #2ecc71;
            margin: 10px 0;
            display: none; /* Escondido at√© calcular a rota */
        }
        
        .btn-cancelar { background: none; border: none; color: #e74c3c; width: 100%; margin-top: 15px; font-weight: 600; }
    </style>
</head>
<body>

    <div id="map"></div>

    <div class="bottom-sheet">
        <div id="tela-pedido">
            <h3 style="text-align: center; margin-bottom: 20px;">Moto Conchas</h3>
            
            <div class="input-group" id="box-gps" onclick="ativarGPS()">
                <div class="dot-origem"></div>
                <input type="text" id="origemInput" value="Toque para usar GPS üìç" readonly>
            </div>

            <div class="input-group">
                <div class="dot-destino"></div>
                <input type="text" id="destinoInput" placeholder="Para onde vamos?">
            </div>

            <div style="display:flex; justify-content:space-between; padding:15px; font-weight:bold; color:#555;">
                <span>Pre√ßo Fixo</span>
                <span style="color:#2ecc71; font-size:1.2em;">R$ 7,00</span>
            </div>

            <button class="btn-confirmar" onclick="enviarPedido()">Chamar Moto</button>
        </div>

        <div id="tela-aguarde" style="display: none; text-align: center;">
            <div class="loader"></div>
            
            <h3 id="tituloStatus">Procurando Moto...</h3>
            
            <div id="tempoChegada" class="tempo-destaque">-- min</div>
            
            <p id="subStatus">Avisando motoristas...</p>
            <button class="btn-cancelar" onclick="location.reload()">Cancelar</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        const map = L.map('map').setView([-23.0134, -48.0089], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        let coords = null;
        let motoMarker = null;
        let rotaControl = null;

        const iconMoto = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/171/171253.png',
            iconSize: [38, 38],
            iconAnchor: [19, 19]
        });

        function ativarGPS() {
            if(!navigator.geolocation) return alert("Sem GPS");
            document.getElementById('origemInput').value = "Localizando...";
            
            navigator.geolocation.getCurrentPosition(pos => {
                coords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                map.setView([coords.lat, coords.lng], 17);
                L.circleMarker([coords.lat, coords.lng], {color: 'blue', radius: 8}).addTo(map);
                document.getElementById('origemInput').value = "Minha Localiza√ß√£o ‚úÖ";
                document.getElementById('box-gps').classList.add('gps-ativo');
            });
        }

        function enviarPedido() {
            const dest = document.getElementById('destinoInput').value;
            if(!coords) return alert("Use o GPS primeiro!");
            if(!dest) return alert("Digite o destino!");

            document.getElementById('tela-pedido').style.display = 'none';
            document.getElementById('tela-aguarde').style.display = 'block';

            db.collection("corridas").add({
                passageiro: "Cliente App",
                origem: coords,
                destino: dest,
                valor: "R$ 7,00",
                status: "pendente",
                data: firebase.firestore.FieldValue.serverTimestamp()
            }).then(doc => acompanharCorrida(doc.id));
        }

        function acompanharCorrida(id) {
            db.collection("corridas").doc(id).onSnapshot(doc => {
                const dados = doc.data();
                
                if(dados.status === "aceito") {
                    document.getElementById('tituloStatus').innerText = "Motorista chegando!";
                    document.getElementById('subStatus').innerText = "A moto est√° a caminho.";
                    document.querySelector('.loader').style.display = 'none';

                    if (dados.motoristaLat && dados.motoristaLng) {
                        const latMoto = dados.motoristaLat;
                        const lngMoto = dados.motoristaLng;

                        if (!motoMarker) {
                            motoMarker = L.marker([latMoto, lngMoto], {icon: iconMoto}).addTo(map);
                        } else {
                            motoMarker.setLatLng([latMoto, lngMoto]);
                        }

                        // Atualiza rota e calcula tempo
                        atualizarRota(latMoto, lngMoto, coords.lat, coords.lng);
                    }
                }
            });
        }

        function atualizarRota(latInicio, lngInicio, latFim, lngFim) {
            const waypoints = [
                L.latLng(latInicio, lngInicio),
                L.latLng(latFim, lngFim)
            ];

            if (rotaControl) {
                rotaControl.setWaypoints(waypoints);
            } else {
                rotaControl = L.Routing.control({
                    waypoints: waypoints,
                    lineOptions: { styles: [{color: 'blue', opacity: 0.7, weight: 5}] },
                    createMarker: function() { return null; },
                    addWaypoints: false,
                    draggableWaypoints: false,
                    fitSelectedRoutes: true,
                    show: false
                })
                .on('routesfound', function(e) {
                    // --- M√ÅGICA DO TEMPO AQUI ---
                    const rotas = e.routes;
                    const resumo = rotas[0].summary;
                    // O tempo vem em segundos, dividimos por 60 para ter minutos
                    const minutos = Math.ceil(resumo.totalTime / 60);
                    
                    const divTempo = document.getElementById('tempoChegada');
                    divTempo.style.display = 'block';
                    divTempo.innerText = minutos + " min";
                })
                .addTo(map);
            }
        }
    </script>
</body>
</html>
