<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Radar de Chuva Moto Pro</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; background: #1a1a1a; color: white; font-family: sans-serif; overflow: hidden; }
        #map { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        
        /* Alerta de Flash */
        #alert-flash {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 999; pointer-events: none; opacity: 0; background: #ffcc00;
        }

        /* HUD - Painel Superior */
        #hud-top {
            position: absolute; top: 15px; width: 100%; z-index: 10;
            display: flex; justify-content: center; pointer-events: none;
        }
        .warning-msg {
            background: rgba(255, 0, 0, 0.9); padding: 12px 25px;
            border-radius: 30px; font-weight: bold; font-size: 1.1rem;
            box-shadow: 0 0 20px rgba(0,0,0,0.5); display: none;
        }

        /* Dashboard Inferior */
        #dashboard {
            position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.85);
            display: flex; justify-content: space-around; padding: 20px 0; z-index: 10;
            border-top: 2px solid #333;
        }
        .stat { text-align: center; }
        .val { font-size: 1.8rem; font-weight: bold; color: #00ff00; display: block; }
        .label { font-size: 0.7rem; color: #888; text-transform: uppercase; }

        #start-screen {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: #000; z-index: 1000; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        button { padding: 25px 50px; font-size: 1.3rem; background: #00ff00; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <div id="start-screen">
        <h2 style="text-align:center">SISTEMA MOTO RADAR</h2>
        <button onclick="ligarSistema()">ATIVAR RADAR E GPS</button>
        <p style="color:#666; margin-top:15px">Aperte para carregar o mapa e sensores</p>
    </div>

    <div id="alert-flash"></div>
    
    <div id="hud-top">
        <div id="aviso" class="warning-msg">⚠️ CHUVA DETECTADA NA ÁREA</div>
    </div>

    <div id="map"></div>

    <div id="dashboard">
        <div class="stat"><span id="speed" class="val">0</span><span class="label">km/h</span></div>
        <div class="stat"><span id="clima" class="val">--</span><span class="label">Tempo</span></div>
        <div class="stat"><span id="alert-status" class="val">OK</span><span class="label">Status</span></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const API_KEY = "d0bd25d6a9954ce24084e7358c237204";
        let map, userMarker, audioCtx;

        function ligarSistema() {
            document.getElementById('start-screen').style.display = 'none';
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            
            // 1. Mapa Base (Troquei para o StreetMap para você ver as ruas)
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView([0,0], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

            // 2. Camada de RADAR (As cores verde, amarelo e vermelho)
            // RainViewer API - Agora configurado para atualizar a cada minuto
            const rainLayer = L.tileLayer('https://tilecache.rainviewer.com/v2/radar/nowcast_5/256/{z}/{x}/{y}/2/1_1.png', {
                opacity: 0.65,
                zIndex: 100
            }).addTo(map);

            iniciarMonitoramento();
        }

        function iniciarMonitoramento() {
            navigator.geolocation.watchPosition(pos => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                const speed = Math.round((pos.coords.speed || 0) * 3.6);

                map.setView([lat, lon]);
                
                if(!userMarker) {
                    userMarker = L.circleMarker([lat, lon], {
                        color: '#007bff', fillColor: '#007bff', fillOpacity: 1, radius: 8
                    }).addTo(map);
                } else {
                    userMarker.setLatLng([lat, lon]);
                }

                document.getElementById('speed').innerText = speed;
                checarAPIClima(lat, lon);

            }, (err) => alert("GPS não encontrado. Verifique as permissões."), { enableHighAccuracy: true });
        }

        async function checarAPIClima(lat, lon) {
            try {
                const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${API_KEY}&units=metric&lang=pt_br`);
                const data = await res.json();
                const condicao = data.weather[0].main;
                
                document.getElementById('clima').innerText = data.weather[0].description;

                // Gatilho de Alerta
                if(["Rain", "Thunderstorm", "Drizzle", "Snow"].includes(condicao)) {
                    ativarAlertas();
                } else {
                    document.getElementById('aviso').style.display = 'none';
                    document.getElementById('alert-status').innerText = "OK";
                    document.getElementById('alert-status').style.color = "#00ff00";
                }
            } catch(e) { console.log("Erro ao conectar na API"); }
        }

        function ativarAlertas() {
            // Texto no Topo
            document.getElementById('aviso').style.display = 'block';
            document.getElementById('alert-status').innerText = "ALERTA";
            document.getElementById('alert-status').style.color = "red";
            
            // Flash Amarelo na tela
            const flash = document.getElementById('alert-flash');
            flash.style.opacity = "0.6";
            setTimeout(() => flash.style.opacity = "0", 250);

            // Beep Sonoro
            if(audioCtx) {
                const osc = audioCtx.createOscillator();
                osc.connect(audioCtx.destination);
                osc.frequency.value = 1000;
                osc.start();
                osc.stop(audioCtx.currentTime + 0.15);
            }
        }
    </script>
</body>
</html>
