<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoramento - Moto Conchas</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;800&display=swap" rel="stylesheet">
    <style>
        body { background: #121212; color: white; font-family: 'Inter', sans-serif; padding: 20px; text-align: center; }
        .container { max-width: 800px; margin: 0 auto; }
        
        .card { background: #1e1e1e; padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 1px solid #333; text-align: left; }
        .card-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 10px; }
        
        .numero { font-size: 2.5rem; font-weight: 800; }
        .verde { color: #2ecc71; }
        .azul { color: #3498db; }
        
        .titulo { color: #888; text-transform: uppercase; letter-spacing: 1px; font-size: 0.9rem; font-weight: bold; }
        
        .lista { max-height: 300px; overflow-y: auto; }
        .item { padding: 10px 0; border-bottom: 1px solid #2a2a2a; display: flex; align-items: center; font-size: 0.95rem; }
        
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .online { background: #2ecc71; box-shadow: 0 0 5px #2ecc71; }
        .offline { background: #e74c3c; }
        .app-open { background: #3498db; }

        .aviso-erro { color: #e74c3c; background: rgba(231, 76, 60, 0.1); padding: 10px; border-radius: 8px; font-size: 0.8rem; margin-top: 10px; display: none; }
    </style>
</head>
<body>

    <div class="container">
        <h2 style="color:#f1c40f;">MONITORAMENTO AO VIVO</h2>
        <p id="relogio" style="color:#666; margin-bottom: 30px; font-size: 0.9rem;">Carregando dados...</p>

        <div id="erroIndex" class="aviso-erro">
            ‚ö†Ô∏è <b>Aten√ß√£o:</b> A consulta falhou. Pode ser necess√°rio criar um √≠ndice no Firebase Console.<br>
            Abra o console do navegador (F12) e clique no link gerado pelo erro.
        </div>

        <div class="card">
            <div class="card-header">
                <span class="titulo">üèçÔ∏è MOTORISTAS CONECTADOS</span>
                <span id="qtdMotoristas" class="numero verde">0</span>
            </div>
            <div id="listaMotoristas" class="lista">
                <p style="color:#555; padding:10px;">Nenhum motorista online...</p>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <span class="titulo">üë• PASSAGEIROS NO APP</span>
                <span id="qtdPassageiros" class="numero azul">0</span>
            </div>
            <div id="listaPassageiros" class="lista">
                <p style="color:#555; padding:10px;">Nenhum passageiro...</p>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        const db = firebase.firestore();

        // Atualiza a cada 5 segundos
        setInterval(atualizarContagem, 5000);
        atualizarContagem();

        function atualizarContagem() {
            document.getElementById('relogio').innerText = "√öltima verifica√ß√£o: " + new Date().toLocaleTimeString();

            // Consideramos "Online" quem mandou sinal nos √∫ltimos 2 minutos
            const limiteTempo = new Date(Date.now() - 2 * 60 * 1000); // 2 minutos atr√°s

            db.collection('users')
                .where('ultimo_visto', '>', limiteTempo)
                .orderBy('ultimo_visto', 'desc') // Ordena do mais recente para o mais antigo
                .get()
                .then(snap => {
                    document.getElementById('erroIndex').style.display = 'none'; // Esconde erro se der certo
                    
                    let pass = 0;
                    let moto = 0;
                    let htmlPass = "";
                    let htmlMoto = "";

                    snap.forEach(doc => {
                        const d = doc.data();
                        const nome = d.nome || "An√¥nimo";
                        const tempoFormatado = d.ultimo_visto ? new Date(d.ultimo_visto.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '--:--';
                        
                        if (d.tipo_usuario === 'motorista') {
                            moto++;
                            // Verifica se o bot√£o "Ficar Online" est√° verde no app dele
                            const statusDot = d.isOnline ? "online" : "offline"; 
                            const statusTexto = d.isOnline ? "Dispon√≠vel" : "Ocupado/Offline";
                            
                            htmlMoto += `
                                <div class="item">
                                    <div class="status-dot ${statusDot}"></div>
                                    <div style="flex:1">
                                        <strong>${nome}</strong> 
                                        <span style="color:#666; font-size:0.8rem">(${statusTexto})</span>
                                    </div>
                                    <div style="font-size:0.8rem; color:#555;">${tempoFormatado}</div>
                                </div>`;
                        } else {
                            pass++;
                            htmlPass += `
                                <div class="item">
                                    <div class="status-dot app-open"></div>
                                    <div style="flex:1">
                                        <strong>${nome}</strong>
                                    </div>
                                    <div style="font-size:0.8rem; color:#555;">${tempoFormatado}</div>
                                </div>`;
                        }
                    });

                    // Atualiza n√∫meros
                    document.getElementById('qtdPassageiros').innerText = pass;
                    document.getElementById('qtdMotoristas').innerText = moto;
                    
                    // Atualiza listas
                    if(htmlPass) document.getElementById('listaPassageiros').innerHTML = htmlPass;
                    else document.getElementById('listaPassageiros').innerHTML = "<p style='color:#555; padding:10px;'>Nenhum passageiro...</p>";

                    if(htmlMoto) document.getElementById('listaMotoristas').innerHTML = htmlMoto;
                    else document.getElementById('listaMotoristas').innerHTML = "<p style='color:#555; padding:10px;'>Nenhum motorista...</p>";
                })
                .catch(err => {
                    console.error("Erro na consulta Admin:", err);
                    if(err.message.includes("index")) {
                        document.getElementById('erroIndex').style.display = 'block';
                    }
                });
        }
    </script>
</body>
</html>
